#!/bin/bash
#$ -cwd #run frow where qsub is called from
#$ -N sga-test-acacia
#$ -o output
#$ -e output

PairedEnd=0
Threads=12

Project="Acacia"
InputFiles="Acacia_NoIndex_L002_R1_001.100bp.fq"
PPFile="${Project}_preprocessed.fastq"

FilterArgs="-f 10 -m 80" # max of 10 bad nts, min length 80
IndexAlg="bcr"

# Pre-process
sga preprocess -p ${PairedEnd} ${FilterArgs} -o ${PPFile} ${InputFiles}

# Error correct
CorrectionKmer=41
CorrectedFile="${Project}_corrected_${CorrectionKmer}"
sga index -a ${IndexAlg} -t ${Threads} --no-reverse ${PPFile}
sga correct -t ${Threads} --discard --learn -k ${CorrectionKmer} -o ${CorrectedFile}.fastq ${PPFile}

# Contig Assembly
CoverageFilter=2
FMMinOverlap=55
FMOutputFile="${Project}_merged_${FMMinOverlap}"
AssemblyOverlap=75
MaxGapDiff=0
RepeatRes=10
AssemblyFile="${Project}_${AssemblyOverlap}.assembly"
sga index -a ${IndexAlg} -t ${Threads} ${CorrectedFile}.fastq
sga filter -t ${Threads} -x ${CoverageFilter} --homopolymer-check --low-complexity-check ${CorrectedFile}.fastq
sga fm-merge -t ${Threads} -m ${FMMinOverlap} -o ${FMOutputFile}.fa ${CorrectedFile}.filter.pass.fa
sga index -d 1000000 -t ${Threads} ${FMOutputFile}.fa
sga rmdup -t ${Threads} ${FMOutputFile}.fa
sga overlap -t ${Threads} -m ${FMMinOverlap} ${FMOutputFile}.rmdup.fa
sga assemble -m ${AssemblyOverlap} -g ${MaxGapDiff} -r ${RepeatRes} -o ${AssemblyFile} ${FMOutputFile}.rmdup.asqg.gz

# Postprocessing
PostProcName=${Project}.pe
Contigs="${AssemblyFile}-contigs.fa"
sga-align --name  ${PostProcName} ${Contigs} ${InputFiles}

